# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [9.1.0] - 2025-08-28

### Added

- 🆕 **'반복적 자가 회복' 메커니즘**: 의미론적 중요도 기반 변수 제거로 안정성 극대화
  - **의미론적 중요도 기반 변수 제거**: 수학적 오류가 아닌 입시 데이터의 특성을 이해하는 방식으로 변수 제거 우선순위 결정
  - **반복적 재시도**: 성공하거나 더 이상 제거할 수 없을 때까지 반복적으로 피팅 시도
  - **상세한 실패 진단**: 최종 실패 시 어떤 핵심 변수들이 남아있었는지 구체적으로 보고
  - **투명한 데이터 보정**: 어떤 변수가 제거되었는지 사용자에게 명확하게 알림
- 🆕 **폰트 설정 우선순위 변경**: 시스템 폰트를 우선적으로 사용하여 성능 향상
  - **시스템 폰트 우선**: 사용자 시스템에 설치된 한글 폰트를 우선적으로 사용
  - **로컬 폰트 폴백**: 시스템 폰트 실패 시 `fonts/NanumGothic.ttf` 폰트로 자동 전환

### Changed

- 🔄 **핵심 함수 개선**:
  - `fit_per_year_models` 함수 전면 재작성: 반복적 자가 회복 로직 구현
  - `run_pipeline` 함수 강화: 상세한 실패 진단 및 에러 메시지 개선
  - `setup_korean_font` 함수 수정: 시스템 폰트 우선 사용으로 변경

### Technical Details

- **변수 제거 우선순위**: `REMOVAL_PRIORITY_LIST`로 지원자 데이터(3순위) → 최초합격자 데이터(2순위) → 최종등록자 데이터(1순위) 순서
- **핵심 변수 그룹**: `ESSENTIAL_GROUP_VARS` 내에서 최소 2개만 유지하면 계속 시도
- **실패 진단 정보**: `remaining_vars_on_fail` 컬럼으로 실패 시점의 남은 변수들 추적
- **상태 관리**: `SUCCESS`, `SUCCESS_AFTER_REMOVAL`, `FAILURE` 상태로 피팅 결과 분류

### Fixed

- 🐛 **모델 범용성 향상**: `final_cut`이나 `median`이 없어도 `mean`과 `p70`만으로 분석 가능
- 🐛 **사용자 경험 개선**: 피팅 실패 시 구체적인 문제 진단 정보 제공

## [9.0.0] - 2025-08-28

### Added

- 🆕 **'유연한 중단 규칙' 메커니즘**: 고정된 필수 변수 목록 대신 유연한 규칙을 적용하여 모델의 범용성을 높임
  - **기존 방식**: `ESSENTIAL_VARS` 고정 목록에 의존하여 `final_cut`이나 `median`이 없으면 분석 불가
  - **새로운 방식**: `ESSENTIAL_GROUP_VARS` 내에서 **최소 2개만 유지**하면 계속 시도
  - **모델 범용성 향상**: `final_cut` 없이 `mean` + `p70`만 있어도 분석 가능

### Changed

- 🔄 **전역 설정 개선**:
  - `ESSENTIAL_VARS` → `ESSENTIAL_GROUP_VARS` + `MIN_ESSENTIAL_VARS`로 변경
  - 핵심 변수 그룹 내에서 최소 2개만 유지하면 계속 시도하는 유연한 규칙 적용

### Technical Details

- **핵심 변수 그룹**: `["median", "p70", "final_cut", "mean", "best"]`
- **최소 유지 개수**: `MIN_ESSENTIAL_VARS = 2`
- **지능적 변수 제거**: 핵심 변수가 2개 이하로 남으면 제거 대상에서 자동 제외

### Fixed

- 🐛 **모델 범용성 문제 해결**: 일부 대학처럼 `최종컷`이나 `50%컷(median)`을 공개하지 않는 경우에도 분석 가능

## [8.0.0] - 2025-08-27

### Added

- 🆕 **'자가 회복 및 보고' 메커니즘**: 모델이 데이터의 내부 일관성을 스스로 진단하고 문제가 있을 경우 지능적으로 대처
  - **부분 무효화 및 재시도**: 피팅 실패 시 문제를 일으키는 특정 데이터 포인트 하나만 무효화하고 피팅을 재시도
  - **최종 실패 시 실행 중단**: 재시도마저 실패할 경우 잘못된 예측을 내보내는 대신 사용자에게 데이터의 문제점을 알리고 실행을 중단
  - **재시도 과정 보고**: 부분 무효화가 성공적으로 수행되었을 경우 어떤 데이터가 보정되었는지 사용자에게 투명하게 보고
- 🆕 **한글 폰트 강제 지정**: `fonts/NanumGothic.ttf` 폰트를 포함하여 Streamlit Cloud에서도 깔끔한 한글 표시 보장
  - **로컬 폰트 우선**: 프로젝트에 포함된 폰트를 우선적으로 사용
  - **폴백 시스템**: 로컬 폰트 실패 시 시스템 폰트로 자동 전환
  - **사용자 피드백**: 폰트 적용 상태를 실시간으로 표시

### Changed

- 🔄 **핵심 함수 개선**:
  - `_objective_function` 함수 확장: `return_details=True` 옵션으로 각 항목별 오차 반환
  - `_fit_underlying_from_competitive` 함수 수정: 최적화에 사용된 `terms` 정보 반환
  - `fit_per_year_models` 함수 전면 개선: 피팅 재시도 로직 및 상태 추적 시스템 추가
  - `project_current_year` 함수 수정: 피팅에 최종 실패한 연도는 제외하여 예측 품질 향상
  - `run_pipeline` 함수 강화: 최종 실패 감지 및 재시도 성공 보고 시스템

### Technical Details

- **피팅 상태 추적**: `fit_status` 컬럼으로 'SUCCESS', 'RETRY_SUCCESS', 'FAILURE' 상태 관리
- **무효화된 컬럼 추적**: `invalidated_col` 컬럼으로 어떤 데이터가 제외되었는지 기록
- **오차 기여도 분석**: `_objective_function`에서 각 데이터 포인트별 오차 계산으로 문제 원인 파악
- **지능적 재시도**: 가장 큰 오차를 유발한 항목을 자동으로 찾아 무효화하고 재시도
- **사용자 투명성**: 데이터 보정 과정을 명확하게 보고하여 신뢰성 향상

### Fixed

- 🐛 **피팅 실패 시 정보 손실 문제 해결**: 무의미한 기본값(3,6) 대신 NaN으로 명시하여 오염된 데이터 방지
- 🐛 **데이터 내부 일관성 문제 해결**: 통계적 모순이 있는 데이터를 자동으로 감지하고 처리
- 🐛 **예측 안정성 향상**: 문제가 있는 데이터를 제외하고 신뢰할 수 있는 예측만 수행

## [7.1.0] - 2025-08-27

### Added

- 🆕 **'최근 가중 평균' 예측 방식 도입**: 선형 추세 예측을 대체하여 모델의 안정성과 현실 반영도 향상
  - `_predict_with_recency_weighted_average` 함수 추가: 최신 데이터에 기하급수적으로 높은 가중치를 부여하는 가중 평균 계산
  - `_get_stochastic_forecast` 함수 개선: '최근 가중 평균'을 예측의 중심점으로 사용하고 과거의 변동성을 반영하여 확률적으로 예측

### Changed

- 🔄 **예측 로직 전면 개선**:
  - `_recency_weighted_forecast` 함수를 `_predict_with_recency_weighted_average`로 교체
  - `project_current_year` 함수의 DNA 예측 로직을 새로운 '최근 가중 평균' 방식으로 변경
  - `_get_stochastic_forecast` 함수의 핵심 로직을 '최근 가중 평균' 방식으로 교체

### Technical Details

- **가중치 계산**: alpha(감소 계수)를 이용해 최신 데이터부터 alpha^0, alpha^1, alpha^2... 순으로 가중치 생성
- **기본 alpha 값**: 0.6 (최신 데이터에 더 높은 가중치 부여)
- **변동성 반영**: 과거의 변동성(단순 평균과의 차이)을 통해 불확실성을 반영
- **함수 시그니처 변경**: `_get_stochastic_forecast`에서 `x_new` 파라미터 제거, `n_scenarios` 위치 변경

### Fixed

- 🐛 **비선형적 변동성 처리 문제 해결**: V자형 패턴 등 입시 데이터의 비선형적 특성을 더 잘 반영
- 🐛 **예측 안정성 향상**: 선형 추세 예측의 한계를 극복하여 더 현실적인 예측 제공

## [7.0.0] - 2025-08-26

### Added

- 🆕 **인과관계 기반 예측(Causal Forecasting)**: '결과'가 아닌 '원인'을 예측하는 새로운 모델 아키텍처
  - 지원자 그룹의 'DNA'(Beta(a,b) 분포) 직접 예측
  - 로버스트 앵커 시스템 대신 beta_a, beta_b 시계열 예측
  - 모델 타입을 "causal_forecast"로 변경

### Changed

- 🔄 **핵심 로직 전면 재설계**: `project_current_year` 함수 완전 재작성

  - 기존: anchor\_\* 컬럼들을 사용하여 미래 결과 지표 예측
  - 새로운: df_fit의 beta_a, beta_b 컬럼 시계열을 직접 예측
  - 복잡한 최적화 과정 제거, 단순하고 안정적인 예측 방식

- 🔄 **UI 개선**:

  - 섹션 제목을 "📝 학과 프로필"로 변경
  - 컬럼 레이아웃 최적화 (2:1, 2:1:2:1)
  - 프로필 파일 저장/불러오기 UI 간소화

- 🔄 **기본 데이터 변경**: 아주대 문화콘텐츠학과 학생부종합ACE로 변경

### Technical Details

- **DNA 예측 로직**: `_recency_weighted_forecast`를 사용하여 beta_a, beta_b 각각 예측
- **폴백 메커니즘**: 예측 실패 시 가장 최근 값 사용, 그래도 없으면 기본값(3.0, 6.0)
- **디버그 패널 간소화**: beta_a, beta_b 중심으로 정보 표시
- **코드 최적화**: to_py_type 함수 로직 간소화

### Fixed

- 🐛 **예측 안정성 문제 해결**: 특정 데이터셋에서 발생하던 비현실적인 예측값 문제 해결
- 🐛 **V자형 트렌드 처리**: 경쟁률 급등으로 인한 최종컷 V자 패턴을 노이즈로 오인하는 문제 해결
- 🐛 **과적합 방지**: 복잡한 앵커 기반 예측 대신 안정적인 DNA 예측으로 전환

### Breaking Changes

- ⚠️ **모델 타입 변경**: "underlying+trunc" → "causal_forecast"
- ⚠️ **예측 방식 변경**: 결과 지표 예측 → 분포 DNA 예측

## [6.2.3] - 2025-08-25

### Added

- 🆕 UI 레이아웃 최적화 (v6.2.3)
  - 입력 폼을 2줄 구조로 재구성하여 화면 공간 효율성 향상
  - 1줄: `|학과명|정원|`
  - 2줄: `|추가충원|입력함|경쟁률|입력함|`

### Changed

- 🔄 입력방식 단순화
  - "입력방식" 선택 드롭다운 제거
  - 경쟁률만 입력 가능하도록 단순화
  - 지원자 수 입력 방식 완전 제거

### Technical Details

- UI 레이아웃을 `st.columns([1, 1])`와 `st.columns([1, 1, 1, 1])`로 2줄 구성
- `ratio_mode` 관련 모든 로직 제거
- `applicants_this_year` 매개변수 제거
- `project_current_year` 함수에서 지원자 수 기반 경쟁률 계산 로직 제거

### Fixed

- 🐛 체크박스 해제 시 값 리셋 로직 개선
  - `on_change` 콜백을 사용하여 StreamlitAPIException 해결
  - `_reset_value_on_uncheck` 헬퍼 함수 추가로 안정적인 상태 관리

## [6.2.2] - 2025-08-25

### Added

- **🆕 UI 레이아웃 최적화**: "올해 입시 정보" 섹션을 한 줄에 배치하여 화면 공간 절약
- **🆕 체크박스 해제 시 값 리셋**: "입력함" 체크박스 해제 시 해당 입력 필드 값을 0으로 자동 리셋

### Features

- **한 줄 레이아웃**: 정원, 입력방식, 추가충원, 경쟁률/지원자수와 각각의 "입력함" 체크박스를 한 줄에 배치
- **자동 값 리셋**: 체크박스 상태 변경 감지 및 입력 필드 값 자동 초기화
- **이전 상태 추적**: 체크박스 상태 변경을 감지하기 위한 `_prev_*` 변수 시스템

### Technical Details

- **컬럼 레이아웃**: 8개 컬럼으로 구성하여 공간 효율성 극대화
- **동적 라벨링**: 입력방식에 따라 경쟁률/지원자수 라벨 동적 변경
- **상태 변경 감지**: `_prev_*` 변수를 통한 체크박스 상태 변경 감지
- **값 리셋 로직**: 체크박스 해제 시 즉시 해당 필드 값을 0으로 리셋

### Fixed

- **🚨 UI 공간 낭비 문제 해결**: 불필요한 세로 공간 제거로 화면 효율성 향상
- **🚨 체크박스 해제 시 값 유지 문제 해결**: 사용자 의도에 맞는 자동 값 리셋 구현

## [6.2.1] - 2025-08-25

### Added

- **🆕 명시적 입력 상태 제어 시스템**: 체크박스로 입력 여부를 명확하게 제어
- **🆕 입력 취소 기능**: 입력한 값을 "입력 안함"으로 되돌릴 수 있는 기능
- **🆕 사용자 의도 명확화**: 실제 0 입력과 정보 미입력을 구분하는 UI

### Features

- **입력 상태 제어**: 추가충원, 경쟁률, 지원자 수에 대한 "입력함" 체크박스 추가
- **필드 활성화/비활성화**: 체크박스 상태에 따른 입력 필드 동적 제어
- **입력 상태 저장**: JSON 프로필에 입력 상태 정보 포함
- **입력 상태 복원**: 저장된 프로필에서 입력 상태 정확하게 복원

### Technical Details

- **입력 상태 추적**: `extra_inputted`, `applicants_inputted`, `ratio_inputted` 플래그
- **자동 추정 로직**: 입력 상태가 False일 때만 자동 추정 수행
- **사용자 입력 보존**: 입력 상태가 True일 때는 0을 포함한 모든 값 보존
- **하위 호환성**: 기존 프로필 파일과의 호환성 유지

### Fixed

- **🚨 0 입력 vs 미입력 구분 불가 문제 해결**: 체크박스로 명확한 구분
- **🚨 입력 변경 추적 불가 문제 해결**: 입력 상태 토글 가능
- **🚨 자동 추정 정확성 문제 해결**: 사용자 의도에 따른 정확한 처리

## [6.2.0] - 2024-12-19

### Added

- 수시 합격 가능성 예측기 Streamlit 앱
- Beta 분포 기반 확률적 모델링
- 과거 데이터 기반 예측 알고리즘
- 시각화 차트 (연도별 추세, 합격 가능성 분포)
- JSON 데이터 저장/불러오기 기능
- 디버그 모드 (전처리/피팅/투영/시뮬 결과 출력)
- **🆕 부분적 데이터 입력 지원**: 모든 값이 없어도 최소 데이터로 예측 가능
- **🆕 자동 추정 시스템**: 경쟁률, 추가충원 등 미입력 시 과거 패턴으로 자동 추정
- **🆕 피팅 모드 자동 선택**: 데이터 상황에 따라 최적 모드 자동 선택

### Features

- **분포 가정**: 전체 지원자 분포를 등급 범위 [1.0, 9.0]에서 Beta(a,b)로 모형화
- **피팅 전략**:
  - 경쟁률/충원 데이터 있는 해: underlying + truncation 방식
  - 경쟁률 없는 해: admitted-only 방식
- **로버스트 앵커**: 입력값 vs 적합치 비교로 anchor\_\* 열 생성
- **올해 투영**: 최근성 가중 회귀로 anchor 시계열 예측
- **시뮬레이션**: N, M 기반으로 최종컷 샘플링 및 합격 확률 계산
- **🆕 부분적 데이터 처리**: 필수값만으로도 예측 실행 가능
- **🆕 자동 추정 엔진**: 경쟁률/추가충원 과거 중앙값 기반 자동 추정
- **🆕 적응형 피팅**: 데이터 상황별 최적 피팅 모드 자동 선택

### Technical Details

- **핵심 정의**: 경쟁률 = 지원자수/정원, 추가충원은 정원 미달분 추가선발
- **선발비율**: q_select = (capacity + extra) / (ratio × capacity)
- **최초합격자 절단비율**: q_init = capacity / M
- **지원자수 계산**: M = ratio × capacity (과거/올해 모두 동일)
- **🆕 자동 추정 로직**: ratio 미입력 시 과거 중앙값, extra 미입력 시 과거 추가충원율 패턴
- **🆕 피팅 모드 분기**: q_select 유무에 따른 underlying+truncation vs admitted-only 자동 선택
- **🆕 부분적 데이터 처리**: 최소 필수값(정원, 과거 컷)만으로도 예측 파이프라인 실행
