# 수시 합격 가능성 예측기 (Streamlit) v11.1.0

## 🎯 프로젝트 개요

수시 입시 결과 데이터를 기반으로 올해 합격 컷의 확률분포를 추정하고, 개인 등급에 대한 합격 확률 및 포지션을 시각화하는 웹 애플리케이션입니다.

## 🧮 핵심 수식 정의

### 기본 개념

- **경쟁률 (ratio)**: 지원자수 대비 정원의 비율
- **추가충원 (extra)**은 "정원 미달분에 대한 추가선발"이며 정원을 늘리지 않음
- **올해 선발인원 N = capacity + extra**
- **지원자수 M = ratio × capacity** (과거/올해 모두 동일 정의)

### 🔄 자동 추정 로직

- **경쟁률 미입력 시**: `ratio = median(과거_경쟁률_데이터)` (과거 중앙값)
- **추가충원 미입력 시**: `extra = capacity × _get_stochastic_forecast(과거_추가충원율_시계열)` (최근 가중 평균 + 변동성 반영)

### 🆕 v11.1 '사용자 투명성 향상' 메커니즘

**v11.1에서 새로 추가된 기능**: 이상치 보정이 발생했을 때 어떤 연도의 데이터가 보정되었는지를 사용자에게 명확하게 알려주어 예측 과정의 투명성을 극대화합니다.

- **보정 정보 반환**: `_winsorize_series` 함수가 보정된 값의 인덱스 리스트를 함께 반환
- **연도 정보 전달**: `project_current_year`에서 보정된 연도 정보를 `winsorized_years`로 전달
- **통합 알림 시스템**: 기존 '데이터 일관성 문제 해결' 알림과 함께 '예측 안정성 확보' 알림을 체계적으로 표시
- **사용자 신뢰도 향상**: 자동 보정 과정을 투명하게 공개하여 모델의 신뢰성 증대

### 🆕 v11.1 '통합 폰트 관리' 메커니즘

**v11.1에서 새로 추가된 기능**: 환경 의존적인 폰트 설정을 우선순위 체인 기반으로 통합하여 모든 환경에서 안정적인 한글 표시를 보장합니다.

- **통합 폰트 관리**: `font_setup.py`로 모든 환경에서 일관된 폰트 설정
- **우선순위 체인**: OS별 시스템 폰트와 동봉 폰트를 우선순위에 따라 자동 선택
- **환경 독립성**: Windows(Malgun Gothic), macOS(AppleGothic), Linux(Noto/Nanum) 자동 감지 및 적용
- **동봉 폰트**: `fonts/NanumGothic.ttf` 포함으로 Streamlit Cloud에서도 완벽한 한글 표시
- **환경 의존 로직 제거**: `findfont` 비교 로직 제거로 환경별 분기 없이 안정적 동작

### 🆕 v11.0 'MAD 기반 이상치 보정' 메커니즘

**v11.0에서 새로 개선된 기능**: v10.0의 분위수 기반 방식에서 MAD(Median Absolute Deviation) 기반 알고리즘으로 전면 교체하여 더 강건한 이상치 탐지 및 보정을 제공합니다.

- **MAD 기반 이상치 탐지**: Modified Z-score를 사용하여 더 강건한 이상치 탐지
- **적은 데이터에 강함**: 3~5개 샘플에서도 안정적으로 이상치 탐지 및 보정
- **이상치에 둔감**: 중앙값 기반 계산으로 탐지하려는 이상치 자체의 영향을 최소화
- **자동 이상치 교체**: 극단값을 정상 데이터의 중앙값으로 자동 치환
- **v10.0 결함 완전 해결**: 3개년 데이터에서도 이상치 보정이 동작하지 않던 문제 완전 해결

### 🆕 v10.0 '이상치 보정(Winsorization)' 메커니즘

**v10.0에서 추가되었으나 v11.0에서 개선된 기능**: DNA(beta_a, beta_b) 예측 전에 극단적인 이상치를 자동으로 감지하고 보정하여 모델의 안정성을 극대화하는 시스템입니다.

- **윈저화 기법 적용**: 상위/하위 분위수(10%, 90%)를 기준으로 극단값을 경계값으로 치환
- **자동 이상치 감지**: 데이터가 4개 이상일 때만 이상치 보정 수행 (3개 이하는 원본 반환)
- **예측 안정성 향상**: 이상치로 인한 예측 왜곡 방지로 더 상식적이고 신뢰할 수 있는 결과 생성
- **데이터 품질 자동 관리**: 피팅된 DNA 데이터의 품질을 자동으로 검증하고 보정하는 전처리 단계

### 🆕 v9.1 '반복적 자가 회복' 메커니즘

**v9.1에서 새로 추가된 기능**: 모델이 데이터의 품질을 스스로 진단하고 지능적으로 대처하는 고도화된 자가 회복 시스템입니다.

- **의미론적 중요도 기반 변수 제거**: 수학적 오류가 아닌 입시 데이터의 특성을 이해하는 방식으로 변수 제거 우선순위 결정
- **반복적 재시도**: 성공하거나 더 이상 제거할 수 없을 때까지 반복적으로 피팅 시도
- **유연한 중단 규칙**: 고정된 필수 변수 대신 핵심 변수 그룹 내에서 최소 2개만 유지하면 계속 시도
- **상세한 실패 진단**: 최종 실패 시 어떤 핵심 변수들이 남아있었는지 구체적으로 보고
- **투명한 데이터 보정**: 어떤 변수가 제거되었는지 사용자에게 명확하게 알림

### 🆕 v9.0 '유연한 중단 규칙' 메커니즘

**v9.0에서 새로 추가된 기능**: 고정된 필수 변수 목록 대신 유연한 규칙을 적용하여 모델의 범용성을 높입니다.

- **기존 방식**: `ESSENTIAL_VARS` 고정 목록에 의존하여 `final_cut`이나 `median`이 없으면 분석 불가
- **새로운 방식**: `ESSENTIAL_GROUP_VARS` 내에서 **최소 2개만 유지**하면 계속 시도
- **모델 범용성 향상**: `final_cut` 없이 `mean` + `p70`만 있어도 분석 가능

### 🆕 v8.0 '2단계 오류 처리' 메커니즘

**v8.0에서 새로 추가된 기능**: 모델이 데이터의 품질을 스스로 진단하고 지능적으로 대처하는 자가 회복 시스템입니다.

- **2단계 오류 구분**: '나쁜 적합(Poor Fit)'과 '완전한 실패(Hard Failure)'를 구분하여 상황에 맞게 대응
- **부분 무효화 및 재시도**: 피팅 실패 시 문제를 일으키는 특정 데이터 포인트 하나만 무효화하고 피팅을 재시도
- **최종 실패 시 실행 중단**: 재시도마저 실패할 경우 잘못된 예측을 내보내는 대신 사용자에게 데이터의 문제점을 알리고 실행을 중단
- **재시도 과정 보고**: 부분 무효화가 성공적으로 수행되었을 경우 어떤 데이터가 보정되었는지 사용자에게 투명하게 보고

### 🆕 v7.1 '최근 가중 평균' 예측 방식

**v7.1에서 새로 추가된 기능**: 선형 추세 예측을 대체하여 모델의 안정성과 현실 반영도를 향상시킵니다.

- **기존 방식**: 선형 회귀 기반 추세 예측으로 V자형 패턴 등 비선형적 변동성을 제대로 반영하지 못함
- **새로운 방식**: 과거 값들의 평균으로 회귀하면서 최신 데이터에 더 큰 가중치를 두는 '최근 가중 평균' 방식
- **핵심 함수**: `_predict_with_recency_weighted_average` - alpha(감소 계수)를 이용해 최신 데이터부터 기하급수적으로 가중치 부여
- **기본 alpha 값**: 0.6 (최신 데이터에 더 높은 가중치 부여)

### 🆕 v7.0 인과관계 기반 예측 (Causal Forecasting)

- **기존 방식**: 결과 지표(최종컷, 평균 등)를 예측하여 역으로 (a,b) 추정
- **새로운 방식**: 지원자 분포의 'DNA'(Beta(a,b) 모수)를 직접 예측
- **예측 대상**: `beta_a`, `beta_b` 시계열 추세를 각각 예측
- **모델 타입**: `causal_forecast` (기존 `underlying+truncation` 대체)
- **🆕 v8.0 확장**: 2단계 오류 처리로 예측 안정성 대폭 향상

### 피팅 모드 자동 선택

- **경쟁률 있음**: `underlying + truncation` (전체 지원자 분포 역추정)
- **경쟁률 없음**: `admitted-only` (합격자 분포만으로 근사)

**최종 예측 모델**: `causal_forecast` (지원자 분포 DNA 직접 예측)

### 선발 비율 계산

- **선발비율 q_select = N / M = (capacity + extra) / (ratio × capacity)** (상한 1.0)
- **최초합격자 절단비율 q_init = capacity / M**

### 분포 모델링

- 전체 지원자 분포: 등급 범위 [1.0, 9.0]에서 **Beta(a,b)** 분포
- 피팅 전략:
  1. 경쟁률 데이터 있는 해: 전체 지원자 분포에서 상위 q_select 절단된 합격자 분포의 분위수/평균 조건을 역문제로 피팅
  2. 경쟁률 없는 해: 합격자 분포 자체를 Beta로 근사하여 입력 지표 맞춤

## 🚀 주요 기능

- **과거 데이터 분석**: 연도별 입시결과(정원/추가충원/컷/평균/최고 등)와 경쟁률 입력
- **예측 모델링**: Beta 분포 기반 확률적 모델로 올해 합격 컷 추정
- **🆕 v11.0 'MAD 기반 이상치 보정'**: v10.0의 분위수 기반 방식에서 MAD 기반 알고리즘으로 전면 교체하여 더 강건한 이상치 탐지 및 보정
- **🆕 v10.0 '이상치 보정(Winsorization)'**: DNA 예측 전 극단적인 이상치를 자동으로 감지하고 보정하여 모델의 안정성 향상
- **🆕 v9.1 '반복적 자가 회복'**: 의미론적 중요도 기반 변수 제거로 안정성 극대화
- **🆕 v9.0 '유연한 중단 규칙'**: 핵심 변수 그룹 내 최소 2개 유지로 모델 범용성 향상
- **🆕 v8.0 '2단계 오류 처리'**: 데이터 품질 자동 진단 및 지능적 자가 회복 시스템
- **🆕 v7.1 '최근 가중 평균' 예측**: 선형 추세 예측을 대체하여 모델의 안정성과 현실 반영도 향상
- **🆕 v7.0 인과관계 기반 예측**: 지원자 분포 DNA(Beta(a,b)) 직접 예측으로 안정성 향상
- **시각화**:
  - 좌측: 연도별 추세 (원본값 ×마커 / 적합치 o마커)
  - 우측: 시뮬레이션 컷 분포 히스토그램 + 영역(안정/적정/소신/위험)
- **데이터 관리**: JSON 형태로 데이터 저장/불러오기
- **디버그 모드**: 전처리/피팅/투영/시뮬 결과를 상세 출력
- **🆕 부분적 데이터 지원**: 모든 값이 없어도 최소 데이터로 예측 가능
- **🆕 자동 추정 시스템**: 경쟁률, 추가충원 등 미입력 시 과거 패턴으로 자동 추정

## 📦 설치 및 실행

### 요구사항

- Python 3.10+
- pip

### 🎨 폰트 설정

**v11.1에서 개선된 기능**: 통합된 폰트 관리 시스템으로 모든 환경에서 안정적인 한글 표시를 보장합니다.

- **통합 폰트 관리**: `font_setup.py`로 모든 환경에서 일관된 폰트 설정
- **우선순위 체인**: OS별 시스템 폰트와 동봉 폰트를 우선순위에 따라 자동 선택
- **환경 독립성**: Windows(Malgun Gothic), macOS(AppleGothic), Linux(Noto/Nanum) 자동 감지 및 적용
- **동봉 폰트**: `fonts/NanumGothic.ttf` 포함으로 Streamlit Cloud에서도 완벽한 한글 표시

### 설치

```bash
git clone <repository-url>
cd SusiPredict
pip install -r requirements.txt
```

### 로컬 실행

```bash
streamlit run app.py
```

### Streamlit Cloud 배포

1. GitHub 저장소와 연동
2. `app.py`를 메인 파일로 지정
3. Python 버전 및 requirements.txt 자동 인식

## 📊 데이터 형식

### JSON 저장 구조

#### 📋 완전한 데이터 예시

```json
{
  "department_name": "학과명",
  "current_year_inputs": {
    "capacity": 30,
    "extra": 5,
    "ratio": 5.0,
    "extra_inputted": true,
    "ratio_inputted": true
  },
  "historical_data": [
    {
      "year": 2023,
      "capacity": 30,
      "extra": 3,
      "final_cut": 2.5,
      "mean_score": 3.2,
      "max_score": 4.1,
      "ratio": 4.0
    }
  ]
}
```

#### 🔸 부분적 데이터 예시 (자동 추정 활용)

```json
{
  "department_name": "학과명",
  "current_year_inputs": {
    "capacity": 30,
    "extra": null, // 미입력 → 과거 추가충원율로 자동 추정
    "ratio": null, // 미입력 → 과거 중앙값으로 자동 추정
    "extra_inputted": false, // 입력하지 않음
    "ratio_inputted": false // 입력하지 않음
  },
  "historical_data": [
    {
      "year": 2023,
      "capacity": 30,
      "extra": 3,
      "final_cut": 2.5, // 필수: 최종컷
      "mean": 3.2, // 권장: 평균
      "best": 4.1, // 선택: 최고점
      "competition_ratio": 4.0 // 권장: 경쟁률
    }
  ]
}
```

### 입력 방식

- **경쟁률 입력**: ratio 값을 직접 입력하여 경쟁률 기반으로 예측
- **자동 추정**: ratio를 입력하지 않으면 과거 데이터의 중앙값으로 자동 추정

### 🔍 부분적 데이터 입력 지원

**중요**: 프로그램은 모든 값이 파악되지 않아도 예측을 수행할 수 있습니다.

#### 📝 필수 입력값

- **정원 (capacity)**: 반드시 입력해야 함 (1 이상)
- **지원자 등급**: 분석하고 싶은 본인의 등급

#### 🔸 선택적 입력값 (없어도 예측 가능)

- **추가충원 (extra)**: 모르면 0으로 두면 자동 추정
- **경쟁률 (ratio)**: 모르면 과거 중앙값으로 자동 추정

#### 📊 과거 데이터 (최소 2년 이상 권장)

- **최소 필수**: year, capacity, final_cut
- **권장 추가**: mean, best, extra, competition_ratio
- **선택사항**: median, p70, init*\*, app*\* (있으면 더 정확)

#### ⚡ 자동 추정 시스템

- **경쟁률 미입력**: 과거 데이터의 중앙값 사용
- **추가충원 미입력**: `_get_stochastic_forecast()`를 통한 최근 가중 평균 + 변동성 반영
- **지원자 분포**: 최고/평균/최저 중 일부만 있어도 Beta 분포 피팅
- **피팅 모드**: 데이터 상황에 따라 자동으로 최적 모드 선택
- **최종 예측**: `causal_forecast` 모델로 지원자 분포 DNA 직접 예측

#### 💡 예측 품질 향상 팁

1. **최소 3년 이상** 과거 데이터 입력
2. **경쟁률 정보**가 있는 연도 우선 입력
3. **지원자 분포 특성** (app\_\*) 입력 시 더 정확한 예측
4. **디버그 모드**로 중간 계산 과정 확인

## 🪛 디버그 모드 사용법

사이드바의 "디버그 모드 (중간값 출력)" 체크 시 다음 정보가 노출됩니다:

1. **전처리 요약**: year, capacity, extra, ratio(raw/effective), N, q_select, M
2. **피팅 요약**: 각 연도의 beta(a,b), model_type, fit_status, invalidated_col, fitted\*\* 값들
3. **올해 파라미터**: a,b, model_type, q_select_this, N, M, ratio_this
4. **컷 샘플/분위수**: g80/g50/g20과 컷 샘플 10개
5. **🆕 v9.1 피팅 상태**: SUCCESS/SUCCESS_AFTER_REMOVAL/FAILURE 상태 및 제거된 변수 정보

### 🔍 부분적 데이터 입력 시 확인 포인트

- **자동 추정된 값들**: ratio_this, extra_this 등이 과거 중앙값으로 설정되었는지 확인
- **피팅 모드**: `underlying+truncation` vs `admitted-only` 중 어떤 모드가 선택되었는지 확인
- **최종 예측 모델**: `causal_forecast` (지원자 분포 DNA 직접 예측)
- **🆕 v9.1 피팅 상태**: SUCCESS/SUCCESS_AFTER_REMOVAL/FAILURE 상태 및 데이터 보정 정보 확인
- **추정 품질**: 과거 데이터가 충분한지, 극단값이 있는지 확인

### 🆕 명시적 입력 상태 제어 시스템

**v6.2.1에서 새로 추가된 기능**: 체크박스로 입력 여부를 명확하게 제어할 수 있습니다.

#### 📋 입력 상태 제어 방법

- **추가충원**: "입력함" 체크박스로 입력 여부 선택
- **경쟁률**: "입력함" 체크박스로 입력 여부 선택

#### ✅ 장점

- **명확한 구분**: 0 입력 vs 미입력을 명확하게 구분
- **입력 취소 가능**: 입력했다가 나중에 "입력 안함"으로 변경 가능
- **투명한 자동 추정**: 어떤 값이 자동 추정되었는지 명확하게 표시

#### 🔧 사용법

1. **자동 추정 원할 때**: 체크박스 해제 → 입력 필드 비활성화 → 과거 패턴으로 자동 추정
2. **직접 입력할 때**: 체크박스 체크 → 입력 필드 활성화 → 원하는 값 입력
3. **입력 취소할 때**: 체크박스 해제 → 입력 필드 비활성화 → 자동 추정으로 전환

### 문제 분석 체크리스트

1. **q_select_this**가 과도하게 낮은지 확인 (N/M이 0.05~0.1대로 수렴하면 컷이 매우 낮아짐)
2. ratio_this 산출 경로 확인 (입력 vs 과거 중앙값)
3. **anchor_final/anchor_best**의 시계열 예측값이 비정상적으로 낮은지 확인
4. weights 설정이 랜드마크를 충분히 제약하고 있는지 확인
5. 필요 시 **mix(회귀 vs 직전값)** 또는 **anchor_tol** 조정

### 🚨 부분적 데이터 입력 시 주의사항

1. **과거 데이터 부족**: 2년 미만이면 예측 불확실성 증가
2. **경쟁률 정보 부족**: 모든 연도에 경쟁률이 없으면 `admitted-only` 모드로 제한적 예측
3. **극단값 영향**: 과거 데이터에 극단값이 있으면 자동 추정 품질 저하
4. **추정 신뢰도**: 디버그 모드에서 자동 추정된 값들의 합리성 확인 필요

### 🆕 현재 제한사항 (v6.2.1 이전)

**v6.2.1 이전 버전의 제한사항** (현재는 해결됨):

- ~~**0 입력 vs 미입력 구분 불가**: 0을 입력한 것과 입력하지 않은 것을 구분할 수 없었음~~
- ~~**입력 변경 추적 불가**: 한 번 입력한 값을 나중에 "입력 안함"으로 변경할 수 없었음~~
- ~~**자동 추정 정확성**: 사용자가 실제로 0을 입력했는데 자동 추정으로 처리될 수 있었음~~

**v6.2.1에서 해결된 사항**:

- ✅ **명시적 입력 상태 제어**: 체크박스로 입력 여부를 명확하게 제어
- ✅ **입력 취소 기능**: 입력한 값을 "입력 안함"으로 되돌릴 수 있는 기능
- ✅ **사용자 의도 명확화**: 실제 0 입력과 정보 미입력을 구분하는 UI

## �� UI 레이아웃 최적화 (v6.2.2)

### 주요 개선사항

- **한 줄 레이아웃**: "올해 입시 정보" 섹션의 모든 요소를 한 줄에 배치하여 화면 공간 효율성 향상
- **자동 값 리셋**: "입력함" 체크박스를 해제하면 해당 입력 필드의 값이 자동으로 초기값(0)으로 리셋
- **상태 추적**: 체크박스 상태 변경을 감지하여 사용자 의도를 정확히 파악

### 장점

- 화면 공간 절약으로 더 많은 정보를 한 번에 표시
- 체크박스 해제 시 자동 리셋으로 사용자 경험 향상
- 명확한 입력 상태 제어로 데이터 일관성 보장

> **참고**: v6.2.3에서 2줄 레이아웃으로 개선되어 현재는 더 효율적인 구조를 사용합니다.

## 🆕 UI 레이아웃 최적화 (v6.2.3)

### 주요 개선사항

- **2줄 레이아웃**: 입력 폼을 2줄 구조로 재구성하여 가독성과 공간 효율성 균형
  - 1줄: `|학과명|정원|`
  - 2줄: `|추가충원|입력함|경쟁률|입력함|`
- **입력방식 단순화**: "입력방식" 선택 드롭다운 제거, 경쟁률만 입력 가능
- **툴팁 정리**: 숫자 입력 필드의 help 툴팁 제거, 체크박스에만 적절한 툴팁 유지

### 장점

- 화면 공간 낭비 최소화
- 사용자 입력 단순화로 혼란 방지
- 일관된 UI 패턴으로 사용성 향상
- 체크박스 해제 시 안정적인 값 리셋

## 🧪 테스트

```bash
pytest tests/
```

### 테스트 케이스

#### 기본 기능 테스트

- ✅ **입력 상태 제어**: 체크박스로 입력 여부 명시적 제어
- ✅ **자동 추정**: 미입력 시 과거 데이터 기반 자동 추정
- ✅ **JSON 저장/복원**: 프로필 파일 저장 및 불러오기
- ✅ **부분적 데이터**: 일부 정보만 입력해도 정상 작동

#### v6.2.1+ 명시적 입력 상태 제어 테스트

- ✅ **체크박스 토글**: 입력함 체크박스 상태 변경 테스트
- ✅ **입력 필드 활성화/비활성화**: 체크박스 상태에 따른 입력 필드 제어
- ✅ **값 전달 로직**: 입력 상태에 따른 None/값 전달 테스트
- ✅ **JSON 구조**: 입력 상태 정보가 포함된 저장 구조 검증
- ✅ **프로필 복원**: 저장된 입력 상태 정보 정확한 복원
- ✅ **엣지 케이스**: 극한값 및 특수 상황 처리 테스트
- ✅ **자동 추정 트리거**: 미입력 시 자동 추정 시스템 정상 작동
- ✅ **사용자 입력 보존**: 입력된 값의 정확한 보존 및 전달

#### v6.2.2+ UI/리셋 테스트

- ✅ **체크박스 해제 시 값 리셋**: 추가충원, 경쟁률 각각의 리셋 동작
- ✅ **이전 상태 추적**: 체크박스 상태 변경 감지 및 추적

#### v6.2.3+ UI 레이아웃 테스트

- ✅ **2줄 레이아웃**: 학과명/정원, 추가충원/입력함/경쟁률/입력함 배치
- ✅ **입력방식 단순화**: 경쟁률만 입력 가능, 지원자 수 입력 방식 제거
- ✅ **툴팁 정리**: 숫자 입력 필드 툴팁 제거, 체크박스 툴팁 유지
- ✅ **안정적인 값 리셋**: on_change 콜백을 사용한 StreamlitAPIException 해결

## 📁 프로젝트 구조

```
.
├─ app.py                  # Streamlit 메인 앱
├─ requirements.txt        # Python 패키지 의존성
├─ requirements-dev.txt    # 개발용 패키지 의존성
├─ README.md              # 프로젝트 문서
├─ CHANGELOG.md           # 변경 이력
├─ CONTRIBUTING.md        # 기여 가이드
├─ DEPLOYMENT.md          # 배포 가이드
├─ .cursorrules           # Cursor 개발 규칙 (Cursor Rules)
├─ tests/                 # 테스트 파일들
│   ├─ test_fit_modes.py  # 피팅 모드 테스트
│   ├─ test_io_modes.py   # 입출력 모드 테스트
│   ├─ test_math_utils.py # 수학 유틸리티 테스트
│   ├─ test_projection.py # 투영 로직 테스트
│   └─ test_input_state_control.py # 입력 상태 제어 테스트
├─ 학과별데이터/          # 학과별 프로필 데이터
└─ LICENSE                # 라이선스
```

## 🤝 기여 가이드

1. `dev` 브랜치에서 개발
2. 테스트 코드 작성 및 실행
3. PR 생성 시 문제 배경, 변경점, 디버그 캡처 포함
4. 코드 리뷰 후 `main` 브랜치로 머지

## 📈 버전 정책

- **Semantic Versioning** 사용
- 현재 버전: `v9.1.0`
- 주요 변경사항은 `CHANGELOG.md`에 기록

## 📄 라이선스

이 프로젝트는 MIT 라이선스 하에 배포됩니다.
